___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "SalesWings Form Submit",
  "categories": ["SALES","PERSONALIZATION","ATTRIBUTION"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "SD Technologies SA",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Track form submissions and leverage your leads' digital interactions with your business in a clever way.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "emailValue",
    "displayName": "Email Value",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The email value to submit. For example, create a DOM Element variable with a matching CSS selector and attribute name 'value', then reference it here as {{Your DOM Element Variable}}."
  },
  {
    "type": "GROUP",
    "name": "eventPropertiesGroup",
    "displayName": "Event Properties / Lead Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "eventProperties",
        "displayName": "Values",
        "help": "Send values to SalesWings lead attributes and event properties to use them for the various SalesWings use cases. For an ID, choose your own ID if the attribute has not been created yet in SalesWings. Creating an attribute in SalesWings later on with this same ID, will make the values visible and usable in SalesWings Falcon. Select the type of data that you are sending. For a value, Insert the variable of the data which you want to send to SalesWings. Add a text or value freely for something that you want to send with every custom event.",
        "newRowButtonText": "Add",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ID",
            "name": "id",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "REGEX",
                "args": [
                  "^[a-zA-Z0-9_]*$"
                ]
              }
            ]
          },
          {
            "defaultValue": "string",
            "displayName": "Type",
            "name": "type",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "number",
                "displayValue": "Number"
              },
              {
                "value": "boolean",
                "displayValue": "True or False"
              },
              {
                "value": "string",
                "displayValue": "Text"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedGroup",
    "displayName": "Advanced",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "pid",
        "displayName": "Target Project ID",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "help": "Only for domains with multiple SalesWings projects enabled: this field selects the target project for this form submission event. If empty, the event will be sent to all projects. For domains with a single SalesWings project enabled, this field should be left empty."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const callInWindow = require('callInWindow');
const makeNumber = require('makeNumber');

// Get the email value from the configured variable
let emailValue = data.emailValue || '';
if (!emailValue) {
  log('No email value provided');
}

// Build the event object
let eventObj = {
  email: emailValue,
  pid: data.pid
};

// Add values object if eventProperties are present
if (data.eventProperties && data.eventProperties.length > 0) {
  eventObj.values = {};
  data.eventProperties.forEach(function(prop) {
    if (prop.id && prop.value) {
      let parsedValue = prop.value;
      
      // Parse value based on type
      if (prop.type === 'boolean') {
        if (prop.value.toLowerCase() === 'true') {
          parsedValue = true;
        } else if (prop.value.toLowerCase() === 'false') {
          parsedValue = false;
        } else {
          // Skip invalid boolean values
          log('Invalid boolean value for property ' + prop.id + ': ' + prop.value);
          return;
        }
      } else if (prop.type === 'number') {
        let numValue = makeNumber(prop.value);
        if (numValue !== null && numValue !== undefined && numValue === numValue) {
          parsedValue = numValue;
        } else {
          // Skip invalid number values
          log('Invalid number value for property ' + prop.id + ': ' + prop.value);
          return;
        }
      }
      // For 'string' type or default, keep as string
      
      eventObj.values[prop.id] = parsedValue;
    }
  });
}

if(!callInWindow('sw','send-form-submit', eventObj)){
  log('Tag not configured properly or script not possible to load');
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sw"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sw.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: simple test
  code: |-
    const mockData = {
      pid:'4723ad53-8a19-43ab-9b0a-e6d3f1fbb2e4',
      emailValue: 'test@example.com'
      // Mocked field values
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

- name: test with event properties
  code: |-
    const mockData = {
      pid:'4723ad53-8a19-43ab-9b0a-e6d3f1fbb2e4',
      emailValue: 'user@example.com',
      eventProperties: [
        {id: 'user_id', type: 'string', value: 'user123'},
        {id: 'premium', type: 'boolean', value: 'true'},
        {id: 'score', type: 'number', value: '95.5'},
        {id: 'active', type: 'boolean', value: 'false'},
        {id: 'count', type: 'number', value: '42'},
        {id: 'verified', type: 'boolean', value: 'True'},
        {id: 'disabled', type: 'boolean', value: 'False'},
        {id: 'invalid_boolean', type: 'boolean', value: 'maybe'},
        {id: 'invalid_number', type: 'number', value: 'not_a_number'},
        {id: 'empty_value', type: 'string', value: ''}
      ]
    };

    // Mock the callInWindow function to capture the call
    let capturedCall = null;
    mock('callInWindow', function(method, action, params) {
      capturedCall = {method: method, action: action, params: params};
      return true;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
    
    // Verify the sw call was made with correct parameters
    assertThat(capturedCall.method).isEqualTo('sw');
    assertThat(capturedCall.action).isEqualTo('send-form-submit');
    assertThat(capturedCall.params.email).isEqualTo('user@example.com');
    assertThat(capturedCall.params.pid).isEqualTo('4723ad53-8a19-43ab-9b0a-e6d3f1fbb2e4');
    
    // Verify values object with correct types
    assertThat(capturedCall.params.values.user_id).isEqualTo('user123');
    assertThat(capturedCall.params.values.premium).isEqualTo(true);
    assertThat(capturedCall.params.values.score).isEqualTo(95.5);
    assertThat(capturedCall.params.values.active).isEqualTo(false);
    assertThat(capturedCall.params.values.count).isEqualTo(42);
    assertThat(capturedCall.params.values.verified).isEqualTo(true);
    assertThat(capturedCall.params.values.disabled).isEqualTo(false);
    
    // Verify invalid values are ignored (should not exist in values object)
    assertThat(capturedCall.params.values.invalid_boolean).isUndefined();
    assertThat(capturedCall.params.values.invalid_number).isUndefined();
    assertThat(capturedCall.params.values.empty_value).isUndefined();


___NOTES___

Created on 7/9/2025, 12:00:00 PM

